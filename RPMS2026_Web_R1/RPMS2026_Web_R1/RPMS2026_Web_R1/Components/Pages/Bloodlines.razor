@page "/bloodlines"
@rendermode InteractiveServer

@using RPMS2026_Web_R1.Data
@using RPMS2026_Web_R1.DTOs
@using Syncfusion.Blazor.Data
@using Syncfusion.Blazor.Grids
@using Microsoft.EntityFrameworkCore
@inject Rpms2026WebContext DbContext

<PageTitle>Bloodlines</PageTitle>

<h1>Birds Bloodline</h1>
<p>This component demonstrates showing data.</p>
<h3>Bloodlines</h3>

@if (dataSource != null)
{
    <SfGrid DataSource="@dataSource" AllowPaging="true" AllowSorting="true">
        <GridPageSettings PageSize="12"></GridPageSettings>
        <GridColumns>
            <GridColumn Field="Id" HeaderText="ID" IsPrimaryKey="true" Width="100" TextAlign="TextAlign.Center"></GridColumn>
            <GridColumn Field="Code" HeaderText="Code" Width="150"></GridColumn>
            <GridColumn Field="Desc" HeaderText="Description" Width="200"></GridColumn>
        </GridColumns>
    </SfGrid>
}
else
{
    <p><em>Loading...</em></p>
}


@code {
    private List<BloodlineDTO>? dataSource;

    protected override async Task OnInitializedAsync()
    {
        dataSource = await DbContext.Bloodlines
            .Select(b => new BloodlineDTO
            {
                Id = b.Id,
                Code = b.Code,
                Desc = b.Desc
            })
            .ToListAsync();
    }

    private async Task ExportToCSV()
    {
        try
        {
            if (dataSource == null || !dataSource.Any())
            {
                errorMessage = "No data to export.";
                return;
            }

            var csv = new StringBuilder();

            // Add header
            csv.AppendLine("ID,Code,Description,Type,Status,Birds");

            // Add data rows
            foreach (var item in dataSource)
            {
                csv.AppendLine($"{item.Id},{EscapeCsv(item.Code)},{EscapeCsv(item.Desc)},{EscapeCsv(item.Type ?? "")},{EscapeCsv(item.Status ?? "")},{item.BirdCount}");
            }

            var fileName = $"Bloodlines_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            var bytes = Encoding.UTF8.GetBytes(csv.ToString());
            var base64 = Convert.ToBase64String(bytes);

            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "text/csv", base64);

            successMessage = $"Exported {dataSource.Count} bloodlines to {fileName}";
            errorMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Export failed: {ex.Message}";
            successMessage = null;
}
